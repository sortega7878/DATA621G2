---
title: 'Data 621 Group 2 HW 3: Crime'
author: 'Members: Omar	Pineda,	Jeff	Littlejohn,	Sergio	Ortega	Cruz,	Chester	Poon,	Simon	Ustoyev'
date: 'Due: October 30, 2019'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE)
```


### Assignment 


Build a binary logistic regression model on the training data set to predict whether the neighborhood will be at risk for high crime levels. You will provide classifications and probabilities for the evaluation data set using your binary logistic regression model. You can only use the variables given to you (or variables that you derive from the variables provided). Use 0.5 threshold. Below is a short description of the variables of interest in the data set: 
 
* zn: proportion of residential land zoned for large lots (over 25000 square feet) (predictor variable)
* indus: proportion of non-retail business acres per suburb (predictor variable)
* chas: a dummy var. for whether the suburb borders the Charles River (1) or not (0) (predictor variable)
* nox: nitrogen oxides concentration (parts per 10 million) (predictor variable)
* rm: average number of rooms per dwelling (predictor variable)
* age: proportion of owner-occupied units built prior to 1940 (predictor variable)
* dis: weighted mean of distances to five Boston employment centers (predictor variable)
* rad: index of accessibility to radial highways (predictor variable)
* tax: full-value property-tax rate per $10,000 (predictor variable)
* ptratio: pupil-teacher ratio by town (predictor variable)
* black: 1000(Bk - 0.63)2 where Bk is the proportion of blacks by town (predictor variable)
* lstat: lower status of the population (percent) (predictor variable)
* medv: median value of owner-occupied homes in $1000s (predictor variable)
* target: whether the crime rate is above the median crime rate (1) or not (0) **(response variable)**



### Write Up:
 
 
####1. Data Exploration

The dataset includes information on 466 neighborhoods in the city of Boston. Despite its East Coast location and reputation as a bastion of liberalism, Boston is among the most racially segregated of American cities. Attempts to integrate the schools using busing in the 1970s led to [sustained violence](https://en.wikipedia.org/wiki/Boston_desegregation_busing_crisis), including deaths. Recent scholarship has highlighted the widespread use of redlining, a process by which institutions such as banks refused to offer mortgages or other financial services to people of certain races if they wished to purchase a home in certain neighborhoods despite creditworthiness. 

In short, one would probably not want to construct a model to predict crime by neighborhood that uses variables such as race without having a clear idea of the model's intended use and an ethical framework for evaluating said model. This, however, is an academic exercise, so we proceed. Let's preview the data.

```{r}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(kableExtra)
url_crime_train <- 'https://raw.githubusercontent.com/littlejohnjeff/Data_621_Fall_2019/master/crime-training-data_modified.csv'
crime_train_data <- read.csv(url_crime_train, header = TRUE)
kable(crime_train_data[1:15,]) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

Expected variables are present. Note that, as indicated in the variables' descriptions, many of the variables have already been scaled or transformed in some way. Let's calculate summary statistics and generate a box plot for further review.

```{r,message=FALSE}
library(psych)
kable(psych::describe(crime_train_data)) %>% kable_styling(bootstrap_options = c("striped", "hover", "responsive"))
```


We see 466 records in our training set and no missing values for any variable. Other than that, without a specific question in mind, it's difficult to draw any conclusions from this big table of numbers. We see no missing values that would require imputation using medians or other methods.

Now, we visualize using box plots. We'll separate the box plots by the target value, which signifies whether or not the neighborhood is high crime. And we'll approximate Boston Red Sox colors.

```{r,message=FALSE}
library(reshape2)
library(dplyr)
library(ggplot2)
crime_plot <- melt(crime_train_data, id.vars= 'target') %>% mutate(target = as.factor(target))

ggplot(data = crime_plot, aes(x = variable, y = value)) + geom_boxplot(aes(fill = target)) + facet_wrap( ~ variable, , dir = "h", scales = 'free') + scale_fill_manual(values=c("blue3", "red3"))
```

The dummy variable (chas) that represents proximity to the Charles River is not meaningful, but clear distinctions in distributions between the neighborhoods in which the crime rate is below and above the median - the target variable by which the box plots are split. We might later look at these values after transformations such as logs.

To check for skewness, let's examine the distribution of each variable independent of target variable value.

```{r,message=FALSE}
ggplot(crime_plot,aes(value)) + geom_histogram(bin=25,fill="Red3") + facet_wrap( ~ variable, , dir = "h", scales = 'free')
```

Skewness abounds. We will file this away for now and revisit in the Data Preparation part of the project. In particular, zn, nox, age, dis, ptratio, and lstat seem likely candidates for transformations.

We will now check for covariance.

```{r,message=FALSE}
library(stats)
library(corrplot)
cor_train <- cor(crime_train_data, method="pearson") 
kable(cor_train, "html") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

We see some very high positive and negative correlations between variables. Let's construct a more effective visualization.

```{r,message=FALSE}
corrplot(cor_train)
```

We see candidates for combination due to covariance.

As a final step, let's look just a correlation between the independent variables and the target variables.

```{r}
cor_train_target <- as.data.frame(cor_train) %>% dplyr::select(target)
kable(cor_train_target, "html") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

Nox, or the concentration of nitrogen oxide, a significant pollutant that's harmful to human health, in a neighborhood, shows the closest correlation with the target variable at .73. Next, age, rad, tax, and indus all correlate with the target value just above .6. Zn showed the largest negative correlation with the target at -.43. Zn represents the percentage of residential lots zoned for large lots, which may be an indicator large rental housing - apartments.

  
  
 
####2. Data Preparation
 
Prior to modelling the training data set, we must prepare the data. We do not have any missing values, so imputation is not required. We will probably actually start with a model that uses all variables regardless of skew or covariance. However, we will definitely progress to using transformations and will also combine variables due to covariance in seeking the construction of accurate and valid models.

Let's look at how transformations might solve distribution issues with some of our variables. Earlier, we saw a strong right skew in the distribution of the variable lstat, which tracks the "lower status" of a neighborhood's population. Probably not the best phrasing.

```{r,message=FALSE}
ggplot(crime_train_data,aes(x=lstat)) + geom_histogram(bin=25,fill="Red3") 
```

What would a log transformation do to this distribution?

```{r,message=FALSE}
ggplot(crime_train_data,aes(x=log(lstat))) + geom_histogram(bin=25,fill="Blue3") 
```

Looks slightly better. Let's generate log transformations for all variables in the dataset.

```{r,message=FALSE}
ggplot(crime_plot,aes(log(value))) + geom_histogram(bin=25,fill="Blue3") + facet_wrap( ~ variable, , dir = "h", scales = 'free')
```

Medv looks slightly better. However, age remains strongly left skewed. Dis is now bimodal.

What about other transformations such as quadratic ones?

```{r,message=FALSE}
ggplot(crime_plot,aes(sqrt(value))) + geom_histogram(bin=25,fill="Yellow3") + facet_wrap( ~ variable, , dir = "h", scales = 'free')
```

Nope. Not a lot of improvement.

In Part 1, we saw high covariances among variables such as rad and tax (.91). To build the best models, we'll likely want to examine combining some of these variables that are correlated to each other, which tends to increase standard errors. This can lead to overfitting and inefficient models. We will not combine variables here but instead revisit this concept in part 3 when evaluating our models.

Our textbooks have also discussed the possibility of creating bins for continuous variables. For example, dis, the weighted distance of means of distances from a neighborhood to five Boston job centers, might be better suited to fall into three categories than to remain a continuous variable for performance reasons. For time's sake, we will not explore this in this assignment.

 
####3. Build Models

Following convention, we will start with a model consisting of all variables, none of which have been transformed. While we've moved on to Part 3, where we will construct the models, the boundary between data preparation and model building is grey. We will to explore transformations and collinearity.

```{r,message=FALSE}
model1_untransformed <- glm(formula = target ~ ., family = "binomial", data = crime_train_data)
summary(model1_untransformed)
```

Our most significant variables generally tie to the variables we saw have the highest correlations with the target value earlier. We have an AIC of 218.05 and a residual deviance of 192.05. 

Let's run further diagnostics on the model. We will set a probability of .5 as being the cutoff for determining if a neighborhood will be high crime. Here, we check the relationship between the logit of the outcome and each predictive variable. (Target and the binary dummy variable chas should be ignored.) Again, these steps also could be labelled as data preparation.

```{r,message=FALSE}
library(tidyr)
probabilities <- predict(model1_untransformed, type = "response")
predicted.classes <- ifelse(probabilities > 0.5, "pos", "neg")
head(predicted.classes)

mydata <- crime_train_data %>%
  dplyr::select_if(is.numeric) 
predictors <- colnames(mydata)

mydata <- mydata %>%
  mutate(logit = log(probabilities/(1-probabilities))) %>%
  gather(key = "predictors", value = "predictor.value", -logit)

ggplot(mydata, aes(logit, predictor.value))+
  geom_point(size = 0.5, alpha = 0.5) +
  geom_smooth(method = "loess") + 
  theme_bw() + 
  facet_wrap(~predictors, scales = "free_y")
```

Tax and zn do not show linear associations with the outcomes in logit scale. Along with the previously discussed lstat, they might benefit from transformations.

Let's use Cook's Distance to check for outliers.

```{r,message=FALSE}
#https://stat.ethz.ch/R-manual/R-devel/library/stats/html/plot.lm.html
plot(model1_untransformed, which = 4, id.n = 3)
```


```{r,message=FALSE}
library(broom)
model1_untransformed.data <- augment(model1_untransformed) %>% 
  mutate(index = 1:n()) 

kable(model1_untransformed.data %>% top_n(3, .cooksd))  %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

An outlier is not necessarily influential. Let's check for that. 

```{r,message=FALSE}
ggplot(model1_untransformed.data, aes(index, .std.resid)) + 
  geom_point(alpha = .5) +
  theme_light()
```

Let's pull that point that's above 3 standardized residuals from 0.

```{rmessage=FALSE}
kable(model1_untransformed.data %>% 
  filter(abs(.std.resid) > 3)) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

Observation 338 is an influential outlier. 

Next, we check multicollinearity.

```{r,message=FALSE}
library(car)
car::vif(model1_untransformed)
```

The rule of thumb is that vif scores above 5 should be judged as having a high amount of multicollinearity. So rm and medv have issues in this regard.

In summary, we have:

1. Multiple predictors that do not have linear relationships with the logit of the outcome variable.
2. One influential outlier - index 338.
3. Two predictors with potentially problematically high multicollinearity.

The above are among many methods to check assumptions and diagnostics of logistic regression models. We will not repeat these steps - other than the summary diagnostics - for our additional attempts at constructing a model to predict high-crime neighborhoods.

<!-- Using the training data, build at least three different binary logistic regression models, using different variables (or the same variables with different transformations). You may select the variables manually, use an approach such as Forward or Stepwise, use a different approach, or use a combination of techniques. Describe the techniques you used. If you manually selected a variable for inclusion into the model or exclusion into the model, indicate why this was done.  -->

<!-- Be sure to explain how you can make inferences from the model, as well as discuss other relevant model output. Discuss the coefficients in the models, do they make sense? Are you keeping the model even though it is counter intuitive? Why? The boss needs to know.  -->

 
####4. Select Models 
 
<!-- Decide on the criteria for selecting the best binary logistic regression model. Will you select models with slightly worse performance if it makes more sense or is more parsimonious? Discuss why you selected your models.   -->

<!-- For the binary logistic regression model, will you use a metric such as log likelihood, AIC, ROC curve, etc.? Using the training data set, evaluate the binary logistic regression model based on (a) accuracy, (b) classification error rate, (c) precision, (d) sensitivity, (e) specificity, (f) F1 score, (g) AUC, and (h) confusion matrix. Make predictions using the evaluation data set. -->

####References
  
####Appendix